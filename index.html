<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cantina Vini</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#7b1c1c">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-neutral-900 text-white min-h-screen flex flex-col">
  <div id="app" class="max-w-6xl mx-auto p-3 sm:p-6 md:p-8 space-y-4 sm:space-y-6 w-full"></div>

  <script type="text/babel">

    // ----------------------------
    // Utils & Storage
    // ----------------------------
    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);
    const sum = (arr) => arr.reduce((a, b) => a + b, 0);
    const LOCAL_KEY = "winecellar:data:v1";

    function useLocalStorageState(key, initial) {
      const [state, setState] = React.useState(() => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : initial;
        } catch {
          return initial;
        }
      });
      React.useEffect(() => {
        try { localStorage.setItem(key, JSON.stringify(state)); } catch {}
      }, [key, state]);
      return [state, setState];
    }

    function normalizeDate(v) {
      if (!v) return undefined;
      const s = v.trim();
      for (let i = 0; i <= s.length - 4; i++) {
        const sub = s.slice(i, i + 4);
        const n = Number(sub);
        if (Number.isInteger(n) && n >= 1900 && n <= 2099) return sub;
      }
      return s;
    }

    function exportToXLSX(items) {
      const rows = items.map((w) => ({
        quantita: w.quantita,
        cantina: w.cantina,
        vino: w.vino,
        denominazione: w.denominazione ?? "",
        annata: w.annata ?? "",
        tipologia: w.tipologia ?? "",
        regione: w.regione ?? "",
        costo: w.costo ?? "",
        temperatura: w.temperatura ?? "",
        uve: w.uve ?? "",
        consumoIdeale: w.consumoIdeale ?? "",
        luogoAcquisto: w.luogoAcquisto ?? "",
        abbinamenti: w.abbinamenti ?? "",
        acquisto: w.acquisto ?? "",
        approvazione: w.approvazione ?? "",
        note: w.note ?? "",
      }));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Cantina");
      XLSX.writeFile(wb, `cantina_export_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // ----------------------------
    // UI Components
    // ----------------------------
    function Stat({ label, value, valueClassName = "" }) {
      return (
        <div className="rounded-2xl shadow-sm border border-neutral-700">
          <div className="p-3 sm:p-4">
            <div className="text-xs sm:text-sm text-neutral-400">{label}</div>
            <div className={`text-lg sm:text-2xl font-semibold ${valueClassName}`}>{value}</div>
          </div>
        </div>
      );
    }

    function RatingDots({ value = 0 }) {
      return (
        <div className="flex gap-1 items-center">
          {[1,2,3,4,5].map((d) => (
            <div key={d} className={d <= value ? "w-2.5 h-2.5 rounded-full bg-red-700" : "w-2.5 h-2.5 rounded-full bg-red-200"} />
          ))}
        </div>
      );
    }

    function CompactRow({ w, onOpen }) {
      return (
        <div
          className="grid grid-cols-[48px_1fr_auto] sm:grid-cols-[56px_1fr_1fr_auto_auto] gap-2 sm:gap-3 items-center p-3 border rounded-2xl hover:shadow-sm transition cursor-pointer text-white"
          onClick={onOpen}
          role="button"
          tabIndex={0}
        >
          <div className="flex items-center justify-center">
            <span className="px-2 py-1 sm:px-3 sm:py-1 border border-red-700 text-red-700 rounded-md text-sm sm:text-base">{w.quantita}</span>
          </div>
          <div className="truncate">
            <div className="font-medium truncate">{w.cantina || "—"}</div>
            <div className="text-xs truncate opacity-80">{w.denominazione || w.tipologia || ""}</div>
          </div>
          <div className="hidden sm:block truncate">
            <div className="truncate">{w.vino || "—"}</div>
            <div className="text-xs opacity-80">{w.annata || ""}</div>
          </div>
          <div className="hidden sm:flex items-center">
            <span className="px-2 py-1 border border-white text-white rounded-md text-sm">{w.costo ? `${w.costo} €` : "—"}</span>
          </div>
          <div className="flex items-center gap-2 justify-end">
            <RatingDots value={w.approvazione} />
          </div>
        </div>
      );
    }

    // ----------------------------
    // Main App
    // ----------------------------
    function WineCellarApp(){
      const [items, setItems] = useLocalStorageState(LOCAL_KEY, []);
      const [selected, setSelected] = React.useState(null);

      const totals = React.useMemo(() => ({
        bottles: sum(items.map(i=>i.quantita||0)),
        labels: new Set(items.filter(i=>(i.quantita||0) > 0).map(i => `${i.cantina} • ${i.vino}`)).size,
        spent: sum(items.filter(i=>(i.quantita||0) > 0).map(i => (i.costo||0) * (i.quantita||0))),
      }), [items]);

      return (
        <div className="space-y-4 sm:space-y-6">
          {/* Header */}
          <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2 sm:gap-3">
            <h1 className="text-xl sm:text-2xl md:text-3xl font-semibold">Cantina personale</h1>
            <div className="flex gap-2">
              <button className="px-3 py-2 sm:px-4 sm:py-2 bg-red-700 rounded-lg hover:bg-red-800 text-white text-sm sm:text-base"
                onClick={()=>exportToXLSX(items)}>
                Esporta
              </button>
            </div>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3">
            <Stat label="Bottiglie" value={totals.bottles} valueClassName="text-red-700" />
            <Stat label="Etichette in cantina" value={totals.labels} />
            <Stat label="Valore stimato (€)" value={totals.spent.toFixed(2)} />
          </div>

          {/* List */}
          <div className="space-y-2 sm:space-y-3">
            {items.length === 0 && (
              <div className="p-4 border rounded-2xl text-center opacity-80">
                Nessun elemento da mostrare. Aggiungi manualmente o importa in seguito.
              </div>
            )}
            {items.map((w) => (
              <CompactRow key={w.id} w={w} onOpen={()=>setSelected(w)} />
            ))}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("app")).render(<WineCellarApp/>);
  </script>

  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log("✅ Service worker registrato"))
        .catch(err => console.error("❌ SW error:", err));
    }
  </script>
</body>
</html>
